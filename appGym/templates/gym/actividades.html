{% extends 'gym/base.html' %} {% load static %} {% block title %}
Actividades del
Gimnasio{% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'styles/actividades.css' %}" />

<div class="container mt-5">
  <div class="card actividad-card shadow-lg">
    <div class="card-header actividad-header text-center">
      <h3 class="mb-0">Actividades del Gimnasio del ITCJ</h3>
      <p class="mt-2 actividad-subtitle">
        Explora las principales actividades disponibles para todos los niveles y
        horarios.
      </p>
    </div>

    <div class="card-body p-4">
      {% if request.session.usuario_admin %}
      <div class="text-start mb-4">
        <button
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#modalAgregar"
        >
          Agregar actividad
        </button>
      </div>
      <div
        class="modal fade"
        id="modalAgregar"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5>Agregar actividad</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="formAgregar" method="POST">
              {% csrf_token %}
              <div class="modal-body">
                <div class="mb-3">
                  <label>Nombre</label>
                  <input name="nombre" class="form-control" required />
                </div>

                <div class="mb-3">
                  <label>Descripci贸n</label>
                  <textarea
                    name="descripcion"
                    class="form-control"
                    rows="3"
                    style="resize: none"
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label>Horario</label>
                  <input name="horario" class="form-control" required />
                </div>
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Guardar</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                  Cancelar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
      <div class="text-center mb-4">
        <h4 class="fw-bold">Entrena, mejora y divi茅rtete</h4>
        <p class="text-muted fs-5">
          El gimnasio ofrece distintas 谩reas y clases dise帽adas para fortalecer
          cuerpo y mente.
        </p>
      </div>

      <!-- Cards -->
      <div id="alertContainer"></div>
      <div class="row g-4 actividad-grid">
        {% for act in actividades %}
        <div class="col-md-4">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body text-center">
              {% if request.session.usuario_admin %}
              <!-- Vista editable para admins -->
              <form
                method="POST"
                action="{% url 'actividad_editar' act.id_actividad %}"
              >
                {% csrf_token %}

                <div class="mb-2 text-start">
                  <label class="fw-bold">Nombre</label>
                  <input
                    type="text"
                    name="nombre"
                    class="form-control"
                    value="{{ act.nombre }}"
                    required
                  />
                </div>

                <div class="mb-2 text-start">
                  <label class="fw-bold">Descripci贸n</label>
                  <textarea
                    name="descripcion"
                    class="form-control"
                    rows="3"
                    style="resize: none"
                  >
{{ act.descripcion }}</textarea
                  >
                </div>

                <div class="mb-2 text-start">
                  <label class="fw-bold">Horario</label>
                  <input
                    type="text"
                    name="horario"
                    class="form-control"
                    value="{{ act.horario }}"
                    required
                  />
                </div>

                <div class="mt-3 d-flex justify-content-center gap-2">
                  <button class="btn btn-success btn-sm btn-editar" data-id="{{ act.id_actividad }}" type="button">
                    Guardar
                  </button>

                  <button
                    class="btn btn-danger btn-sm btn-eliminar"
                    data-id="{{ act.id_actividad }}"
                    type="button"
                  >
                    Eliminar
                  </button>
                </div>
              </form>

              {% else %}
              <!-- Vista normal -->
              <h5 class="section-title">{{ act.nombre }}</h5>
              <p class="text-muted">{{ act.descripcion }}</p>
              <ul class="actividad-list list-unstyled">
                <li><strong>Horario:</strong> {{ act.horario }}</li>
              </ul>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center text-muted mt-4">
          No hay actividades registradas.
        </p>
        {% endfor %}
      </div>

      <!-- Bot贸n volver -->
      <div class="text-center mt-4">
        <a href="{% url 'index' %}" class="btn btn-back">Volver</a>
      </div>
    </div>
  </div>
</div>
<!-- MODAL CONFIRMAR ELIMINACIN -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar actividad</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body fs-5">
        驴Est谩s seguro que deseas eliminar esta actividad?
        <p class="text-muted mt-2 mb-0">
          Esta acci贸n no se puede deshacer.
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button class="btn btn-danger" id="btnConfirmarEliminar">
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  let idAEliminar = null;
  const csrftoken = getCookie("csrftoken");
  const formAgregar = document.getElementById("formAgregar");

  formAgregar.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = new FormData(formAgregar);
    const csrftoken = document.querySelector(
      "[name=csrfmiddlewaretoken]"
    ).value;

    const response = await fetch("{% url 'actividad_agregar' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: data,
    });

    const result = await response.json();

    showAlert(result.message, result.success ? "success" : "danger");

    if (result.success) {
      formAgregar.reset();

      //  Cerrar modal correctamente
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("modalAgregar")
      );
      modal.hide();

      actualizarActividades();
    }
  });

  function showAlert(message, type = "info") {
    document.getElementById("alertContainer").innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
      ${message}
      <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  }

  async function actualizarActividades() {
  const resp = await fetch("{% url 'actividades_json' %}");
  const data = await resp.json();

  const grid = document.querySelector(".actividad-grid");
  grid.innerHTML = "";

  data.actividades.forEach(a => {

    if (data.is_admin) {
      grid.innerHTML += `
      <div class="col-md-4">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <form class="form-editar" data-id="${a.id_actividad}">
              <div class="mb-2 text-start">
                <label class="fw-bold">Nombre</label>
                <input type="text" name="nombre" class="form-control" value="${a.nombre}">
              </div>

              <div class="mb-2 text-start">
                <label class="fw-bold">Descripci贸n</label>
                <textarea name="descripcion" class="form-control" rows="3" style="resize:none">${a.descripcion}</textarea>
              </div>

              <div class="mb-2 text-start">
                <label class="fw-bold">Horario</label>
                <input type="text" name="horario" class="form-control" value="${a.horario}">
              </div>

              <div class="d-flex justify-content-center gap-2 mt-3">
                <button type="button" class="btn btn-success btn-sm btn-guardar" data-id="${a.id_actividad}">Guardar</button>
                <button type="button" class="btn btn-danger btn-sm btn-eliminar" data-id="${a.id_actividad}">Eliminar</button>
              </div>
            </form>
          </div>
        </div>
      </div>`;
    } else {
      grid.innerHTML += `
      <div class="col-md-4">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <h5 class="section-title">${a.nombre}</h5>
            <p class="text-muted">${a.descripcion}</p>
            <ul class="actividad-list list-unstyled">
              <li><strong>Horario:</strong> ${a.horario}</li>
            </ul>
          </div>
        </div>
      </div>`;
    }
  });

  // 锔 reatacha eventos a botones
  bindEditarEliminar();
}
document.addEventListener("click", (e) => {
  // Solo botones eliminar
  if (!e.target.classList.contains("btn-eliminar")) return;

  idAEliminar = e.target.dataset.id;

  const modal = new bootstrap.Modal(document.getElementById("modalEliminar"));
  modal.show();
});
document.querySelectorAll(".btn-editar").forEach(button => {
  button.addEventListener("click", async () => {
    const id = button.dataset.id;
    const form = button.closest("form");
    const formData = new FormData(form);

    try {
      const resp = await fetch(`/actividades/editar/${id}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
        },
        body: formData,
      });

      const result = await resp.json(); // <-- IMPORTANTE

      showAlert(result.message, result.success ? "success" : "danger");

      if (result.success) {
        actualizarActividades();
      }

    } catch (error) {
      showAlert("Error procesando la edici贸n", "danger");
    }
  });
});
function bindEditarEliminar() {

  // EDITAR
  document.querySelectorAll(".btn-guardar").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const form = btn.closest("form");
      const formData = new FormData(form);

      const resp = await fetch(`/actividades/editar/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: formData
      });

      const result = await resp.json();
      showAlert(result.message, result.success ? "success" : "danger");

      if (result.success) actualizarActividades();
    });
  });

  // ELIMINAR
  document.querySelectorAll(".btn-eliminar").forEach(btn => {
    btn.addEventListener("click", async () => {
            // Solo botones eliminar
      if (!e.target.classList.contains("btn-eliminar")) return;

      idAEliminar = e.target.dataset.id;

      const modal = new bootstrap.Modal(document.getElementById("modalEliminar"));
      modal.show();
    });
  });
}

document.getElementById("btnConfirmarEliminar").addEventListener("click", async () => {
  if (!idAEliminar) return;

  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  const resp = await fetch(`/actividades/eliminar/${idAEliminar}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrftoken,
    },
  });
  const result = await resp.json();

  // Ocultamos el modal
  const modal = bootstrap.Modal.getInstance(document.getElementById("modalEliminar"));
  modal.hide();

  showAlert(result.message, result.success ? "success" : "danger");

  if (result.success) {
    actualizarActividades();
  }
});
</script>
{% endblock %}
